// Prisma schema for PostgreSQL
// Generated by requirements

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")   // app / general usage
  directUrl = env("DIRECT_URL")     // migrations / push / studio
}

enum Gender {
  M
  F
}

enum Role {
  Doctor
  AdminAssistant
  ITAdmin
}

enum AppointmentStatus {
  Scheduled
  CheckedIn
  InProgress
  Completed
  Cancelled
}

model Patient {
  patientId    String   @id @default(uuid()) @db.Uuid
  name         String
  dob          DateTime @db.Date
  gender       Gender
  contact      String?
  insurance    String?
  createdAt    DateTime @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  appointments Appointment[]
  visits       Visit[]
  observations Observation[]
}

model Doctor {
  doctorId    String   @id @default(uuid()) @db.Uuid
  name        String
  department  String
  createdAt   DateTime @default(now())

  appointments  Appointment[]
  availabilities DoctorAvailability[]
  blackouts      DoctorBlackout[]
  visits       Visit[]
  observations Observation[]
}

model Appointment {
  appointmentId String             @id @default(uuid()) @db.Uuid
  patientId     String             @db.Uuid
  doctorId      String             @db.Uuid
  department    String
  date          DateTime
  startTimeMin  Int
  endTimeMin    Int
  reason        String?
  location      String?
  status        AppointmentStatus @default(Scheduled)
  cancelReason  String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  patient Patient @relation(fields: [patientId], references: [patientId])
  doctor  Doctor  @relation(fields: [doctorId], references: [doctorId])

  @@index([doctorId, date, startTimeMin, endTimeMin])
  @@index([patientId, date])
}

model DoctorAvailability {
  availabilityId String @id @default(uuid()) @db.Uuid
  doctorId       String @db.Uuid
  dayOfWeek      Int
  startMin       Int
  endMin         Int

  doctor Doctor @relation(fields: [doctorId], references: [doctorId])

  @@index([doctorId, dayOfWeek])
}

model DoctorBlackout {
  blackoutId String   @id @default(uuid()) @db.Uuid
  doctorId   String   @db.Uuid
  startAt    DateTime
  endAt      DateTime
  reason     String?

  doctor Doctor @relation(fields: [doctorId], references: [doctorId])

  @@index([doctorId, startAt, endAt])
}

model Visit {
  visitId     String   @id @default(uuid()) @db.Uuid
  patientId   String   @db.Uuid
  visitDate   DateTime @db.Date
  doctorId    String   @db.Uuid
  department  String
  reason      String?
  createdAt   DateTime @default(now())

  patient      Patient     @relation(fields: [patientId], references: [patientId])
  doctor       Doctor      @relation(fields: [doctorId], references: [doctorId])
  diagnoses    Diagnosis[]
  medications  Medication[]
  labResults   LabResult[]
  observations Observation[]

  @@index([patientId, visitDate(sort: Desc)])
  @@index([doctorId, visitDate(sort: Desc)])
}

model Diagnosis {
  diagId     String   @id @default(uuid()) @db.Uuid
  visitId    String   @db.Uuid
  diagnosis  String
  createdAt  DateTime @default(now())

  visit Visit @relation(fields: [visitId], references: [visitId])
}

model Medication {
  medId         String   @id @default(uuid()) @db.Uuid
  visitId       String   @db.Uuid
  drugName      String
  dosage        String?
  instructions  String?
  createdAt     DateTime @default(now())

  visit Visit @relation(fields: [visitId], references: [visitId])
}

model LabResult {
  labId           String   @id @default(uuid()) @db.Uuid
  visitId         String   @db.Uuid
  testName        String
  resultValue     Float?
  unit            String?
  referenceRange  String?
  testDate        DateTime? @db.Date
  createdAt       DateTime @default(now())

  visit Visit @relation(fields: [visitId], references: [visitId])
}

model Observation {
  obsId        String   @id @default(uuid()) @db.Uuid
  visitId      String   @db.Uuid
  patientId    String   @db.Uuid
  doctorId     String   @db.Uuid
  noteText     String
  bpSystolic   Int?
  bpDiastolic  Int?
  heartRate    Int?
  temperatureC Float?
  spo2         Int?
  bmi          Float?
  createdAt    DateTime @default(now())

  visit   Visit   @relation(fields: [visitId], references: [visitId])
  patient Patient @relation(fields: [patientId], references: [patientId])
  doctor  Doctor  @relation(fields: [doctorId], references: [doctorId])

  @@index([patientId, doctorId, createdAt(sort: Desc)])
}

model User {
  userId       String   @id @default(uuid()) @db.Uuid
  email        String   @unique
  passwordHash String
  role         Role
  status       String   @default("active")
  doctorId     String?  @db.Uuid
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  doctor   Doctor?  @relation(fields: [doctorId], references: [doctorId])
  sessions Session[]

  @@unique([doctorId])
}

model Session {
  sessionId        String   @id @default(uuid()) @db.Uuid
  userId           String   @db.Uuid
  refreshTokenHash String
  issuedAt         DateTime
  expiresAt        DateTime
  revokedAt        DateTime?
  ip               String?
  ua               String?

  user User @relation(fields: [userId], references: [userId])
}

model AuthAudit {
  id      String   @id @default(uuid()) @db.Uuid
  userId  String?  @db.Uuid
  event   String
  outcome String
  meta    Json?
  ts      DateTime @default(now())
}
